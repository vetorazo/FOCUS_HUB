<div class="container mt-4">
  <!-- Top section: Lens and owner info -->
  <div class="row align-items-center mb-4">
    <div class="col-12 mb-2">
      <h2 class="mb-0">
        <%= @listing.lens.brand %> <%= @listing.lens.model %>
        <small class="text-muted ms-3" style="font-size: 1.5rem;">
          Owner: <%= @listing.user.first_name %> <%= @listing.user.last_name %>
        </small>
      </h2>
    </div>

    <%# If the user attached a photo show the uploaded photo, otherwise just keep the line below %>
    <%# If there are multiple photos attached with cloudinary, show a carousel %>
    <div class="col-md-4 text-center mb-3 mb-md-0">
      <% if @listing.photos.attached? %>
        <div id="carousel" class="carousel slide">
          <div class="carousel-inner">
            <% @listing.photos.each_with_index do |photo, i| %>
              <div class="carousel-item <%= "active" if i == 0 %>">
                <%= cl_image_tag photo.key, class: "img-fluid rounded", style: "height: 250px; width: 400px;", crop: :fill %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            <% end %>
          </div>
        </div>
      <% else %>
        <%= image_tag "https://image.pollinations.ai/prompt/lens+for+camera+#{@listing.lens.model.gsub(' ', '+')}", class: "img-fluid rounded", style: "max-height: 250px;" %>
      <% end %>
    </div>
    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body d-flex flex-column h-100">
          <h5 class="card-title">Description</h5>
          <p class="card-text"><%= @listing.owner_description %></p>
          <div class="mt-auto text-end">
            <span class="badge rounded-pill bg-danger fs-5">
              Â¥<%= @listing.daily_rate %>/day
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if @listing.bookings.where(user: current_user).any? && !@current_user_is_owner%>
    <%= render 'reviews/form', review: @review, listing: @listing %>
  <% end %>

  <!-- Reviews section at the bottom -->
  <div class="mt-5">
    <hr>
    <h3>Reviews</h3>
    <% if @reviews.any? %>
      <% @reviews.each do |review| %>
        <div class="card mb-3">
          <div class="card-body">
            <strong><%= review.user.user_name %></strong>
            <span class="badge bg-warning text-dark ms-2">Rating: <%= review.rating %>/5</span>
            <p class="mt-2 mb-0"><%= review.content %></p>
          </div>
        </div>
      <% end %>
    <% else %>
      <p>No Reviews Yet</p>
    <% end %>
    <%= link_to "Back to lens", lens_listings_path(@listing.lens), class: "btn btn-secondary mt-3" %>
    <hr>
  </div>

  <!-- Booking details and form remain unchanged -->
  <% unless @current_user_is_owner %>
    <div class="display-booking-details">
      <% if @listing.bookings.where(user: current_user).empty?%>
        <h4>You have no bookings for this listing yet! Book now! ðŸ‘‡</h4>
      <% end %>
      <% if @listing.bookings.where(user: current_user).any?%>
        <h4>Your booking details:</h4>
        <% booking = @listing.bookings.where(user: current_user).last%>
        <p> Start date: <%= booking.start_date %> </p>
        <p> End date: <%= booking.end_date %> </p>
        <p> Total price: Â¥<%= booking.total_price %> </p>
        <p> Status: <%= booking.status.capitalize %> </p>
      <% end %>
    </div>
  <% else %>
    <h4>Upcoming bookings</h4>
    <% @listing.bookings.upcoming.each do |booking| %>
      <% if booking.user == current_user %>
        <p>Username: <%= booking.user.user_name %> (Me)</p>
        <p> Start date: <%= booking.start_date %> </p>
        <p> End date: <%= booking.end_date %> </p>
        <p> Status: <%= booking.status.capitalize %> </p>
      <% else %>
        <p>Username: <%= booking.user.user_name %></p>
        <p> Start date: <%= booking.start_date %> </p>
        <p> End date: <%= booking.end_date %> </p>
        <p> Total price: Â¥<%= booking.total_price %> </p>
        <p> Status: <%= booking.status.capitalize %> </p>
        <%= simple_form_for(booking) do |f| %>
          <%= f.input :status, collection: Booking.statuses.keys, prompt: "Select Status", label: "Update Status"%>
          <%= f.button :submit, "Update" %>
        <% end %>
      <% end %>
      <hr>
    <% end %>
  <% end %>

  <% unless @current_user_is_owner %>

    <h2>Book This Listing</h2>
      <div class="alert-success">
        <%# <h5>Note: Bookings that start and end on the same day will still be charged the full daily rate.</h5> %>
      </div>

    <%= render 'bookings/form', listing: @listing, booking: @booking %>
    <hr>
  <% else %>
    <h2>Blackout This Listing</h2>
      <div class="alert-success">
        <h5>Note: This feature is for listing owner only.</h5>
      </div>

    <%= simple_form_for([@listing, @blackout], method: :post, url: listing_blackouts_path(@listing)) do |f| %>
      <%= f.input :start_date,
              as: :string,
              label: "Specify the blackout duration",
              input_html: { data: {controller: "datepicker", datepicker_current_bookings_value: @listing.booked_dates} }  %>
      <%= f.button :submit, "Book Now" %>
    <% end %>
  <% end %>
</div>
