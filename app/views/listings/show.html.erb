<div class="container mt-4">
  <!-- Top section: Lens and owner info -->
  <div class="row align-items-center mb-4">
    <div class="col-12 mb-2">
      <h2 class="mb-0">
        <%= @listing.lens.brand %> <%= @listing.lens.model %>
        <small class="text-muted ms-3" style="font-size: 1.5rem;">
          Owner: <%= @listing.user.first_name %> <%= @listing.user.last_name %>
        </small>
      </h2>
    </div>
    <div class="col-md-4 text-center mb-3 mb-md-0">
      <%= image_tag "https://image.pollinations.ai/prompt/lens+for+camera+#{@listing.lens.model.gsub(' ', '+')}", class: "img-fluid rounded", style: "max-height: 250px;" %>
    </div>
    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body d-flex flex-column h-100">
          <h5 class="card-title">Description</h5>
          <p class="card-text"><%= @listing.owner_description %></p>
          <div class="mt-auto text-end">
            <span class="badge rounded-pill bg-danger fs-5">
              Â¥<%= @listing.daily_rate %>/day
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% unless @listing.bookings.where(user: current_user).empty? %>
    <%= render 'reviews/form', review: @review, listing: @listing %>
  <% end %>

  <!-- Reviews section at the bottom -->
  <div class="mt-5">
    <hr>
    <h3>Reviews</h3>
    <% if @reviews.any? %>
      <% @reviews.each do |review| %>
        <div class="card mb-3">
          <div class="card-body">
            <strong><%= review.user.user_name %></strong>
            <span class="badge bg-warning text-dark ms-2">Rating: <%= review.rating %>/5</span>
            <p class="mt-2 mb-0"><%= review.content %></p>
          </div>
        </div>
      <% end %>
    <% else %>
      <p>No Reviews Yet</p>
    <% end %>
    <%= link_to "Back to lens", lens_listings_path(@listing.lens), class: "btn btn-secondary mt-3" %>
    <hr>
  </div>

  <!-- Booking details and form remain unchanged -->
  <div class="display-booking-details">
    <% if @listing.bookings.empty? || !@listing.bookings.empty? && @listing.bookings.where(user: current_user).empty?%>
      <h4>You have no bookings for this listing yet! Book now! ðŸ‘‡</h4>
    <% end %>
    <% if !@listing.bookings.empty? && !@listing.bookings.where(user: current_user).empty?%>
      <h4>Your booking details:</h4>
      <% booking = @listing.bookings.where(user: current_user).last%>
      <p> Start date: <%= booking.start_date %> </p>
      <p> End date: <%= booking.end_date %> </p>
      <p> Total price: Â¥<%= booking.total_price %> </p>
      <p> Status: <%= booking.status.capitalize %> </p>
    <% end %>
  </div>
  <hr>

  <% unless @current_user_is_owner %>

    <h2>Book This Listing</h2>
      <div class="alert-success">
        <%# <h5>Note: Bookings that start and end on the same day will still be charged the full daily rate.</h5> %>
      </div>

    <%= render 'bookings/form', listing: @listing, booking: @booking %>
    <hr>
  <% else %>
    <h2>Blackout This Listing</h2>
      <div class="alert-success">
        <h5>Note: This feature is for listing owner only.</h5>
      </div>

    <%= simple_form_for([@listing, @blackout], method: :post, url: listing_blackouts_path(@listing)) do |f| %>
      <%= f.input :start_date,
              as: :string,
              label: "Specify the blackout duration",
              input_html: { data: {controller: "datepicker", datepicker_current_bookings_value: @current_booking_dates} }  %>
      <%= f.button :submit, "Book Now" %>
    <% end %>
  <% end %>
</div>
